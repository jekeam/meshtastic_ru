---
id: canned-message
title: Настройка модуля шаблонных сообщений
sidebar_label: Шаблонные сообщения
description: Настройка шаблонных предопределённых сообщений на устройстве Meshtastic
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import { Icon } from "@iconify/react";
import ReactPlayer from "react-player";

Модуль шаблонных сообщений позволяет отправлять сообщения в Mesh прямо с устройства, без приложения на телефоне. Можно заранее задать тексты и выбирать из них.

Варианты настроек модуля: Enabled, Send Bell, Messages, Input Source, Rotary Encoder Enabled, Up Down Encoder Enabled, Input Broker Pin A, Input Broker Pin B, Input Broker Pin Press, Input Broker Event Clockwise, Input Broker Event Counter Clockwise и Input Broker Event Press. Настройка Шаблонные сообщения использует admin‑сообщение с protobuf `ConfigModule.CannedMessage`.

<div style={{ maxWidth: "800px", margin: "auto" }}>
  <ReactPlayer
    url="https://youtu.be/qKQVYUbLLkg"
    controls
    width="100%"
    height="400px"
  />
</div>

## Параметры модуля шаблонных сообщений {#canned-message-module-config-values}

### Включено {#enabled}

Включает модуль шаблонных сообщений.

### Отправлять звонок {#send-bell}

Отправлять символ звонка вместе с каждым сообщением.

Модуль [External Notification Module](external-notification.mdx) можно настроить на звуковой сигнал при получении нового сообщения.
Также его можно настроить так, чтобы он пищал только если в сообщении есть символ звонка.

### Сообщения {#messages}

Список заготовок, заданный пользователем. Сообщения разделяются символом вертикальной черты `|`. Общий размер списка — до 200 байт.

### Источник ввода {#input-source}

Источники событий ввода, которые принимает модуль шаблонных сообщений.

| Значение | Описание |
| :-------------: | :------------------------------------------------------------------: |
|     `_any`      | По умолчанию. Любые периферийные устройства ввода, подключённые к устройству. |
|    `rotEnc1`    | Обычный Rotary Encoder |
|  `upDownEnc1`   | Up/Down Encoder (также для RAK14006 Rotary Encoder) |
| `scanAndSelect` | Одна кнопка (короткое и длинное нажатие) |
|    `cardkb`     | M5Stack CardKB (также RAK14004 Keymatrix) |
|   `serialkb`    | Chatter serial keypad |

### Rotary Encoder включён {#rotary-encoder-enabled}

Включить стандартный rotary encoder.

### Up/Down Encoder включён {#up-down-encoder-enabled}

Включить up/down encoder.

### Input Broker Pin A {#input-broker-pin-a}

Номер GPIO (1–39) для входа A энкодера

### Input Broker Pin B {#input-broker-pin-b}

Номер GPIO (1–39) для входа B энкодера

### Input Broker Pin Press {#input-broker-pin-press}

Номер GPIO (1–39) для входа Press

### Input Broker Event Clockwise {#input-broker-event-clockwise}

Генерировать событие поворота по часовой стрелке.

### Input Broker Event Counter Clockwise {#input-broker-event-counter-clockwise}

Генерировать событие поворота против часовой стрелки.

### Input Broker Event Press {#input-broker-event-press}

Генерировать событие при нажатии.

## Доступность настроек модуля на клиентах {#canned-message-module-config-client-availability}

<Tabs
  groupId="settings"
  defaultValue="apple"
  values={[
    {
      label: (
        <>
          <Icon icon="mdi:android" height="1.5rem" style={{ marginRight: "0.25rem" }} /> Android
        </>
      ),
      value: "android",
    },
    {
      label: (
        <>
          <Icon icon="mdi:apple" height="1.5rem" style={{ marginRight: "0.25rem" }} /> Apple
        </>
      ),
      value: "apple",
    },
    {
      label: (
        <>
          <Icon icon="mdi:terminal" height="1.5rem" style={{ marginRight: "0.25rem" }} /> CLI
        </>
      ),
      value: "cli",
    },
    {
      label: (
        <>
          <Icon icon="mdi:internet" height="1.5rem" style={{ marginRight: "0.25rem" }} /> Web
        </>
      ),
      value: "web",
    },
  ]}>
<TabItem value="android">

#### Android

:::note заметка

Настройки Шаблонные сообщения доступны на Android.

1. Откройте приложение Meshtastic
2. Перейдите: **Вертикальное многоточие (3 точки справа вверху) > Конфигурация радио > Шаблонные сообщения**

:::

</TabItem>
<TabItem value="apple">

#### Apple

:::note заметка
Все параметры модуля шаблонных сообщений доступны на iOS, iPadOS и macOS: Настройки > Конфигурация модуля > Шаблонные сообщения.
:::

</TabItem>
<TabItem value="cli">

#### CLI

:::note заметка

Все параметры модуля доступны в python CLI.

:::

Примеры команд ниже:

| Параметр | Допустимые значения | По умолчанию |
| :------------------------------------: | :---------------------------------------: | :-------------------------: |
|         canned_message.enabled         |              `true`, `false`              |           `false`           |
|        canned_message.send_bell        |              `true`, `false`              |           `false`           |
|   canned_message.allow_input_source    | `rotEnc1`, `_any`, `upDownEnc1`, `cardkb` |           `_any`            |
|          --set-canned-message          |                 `string`                  | `""` (separate using pipes) |
|  canned_message.inputbroker_event_cw   |             `InputEventChar`              |        (not defined)        |
|  canned_message.inputbroker_event_ccw  |             `InputEventChar`              |        (not defined)        |
| canned_message.inputbroker_event_press |             `InputEventChar`              |        (not defined)        |
|    canned_message.inputbroker_pin_a    |                 `integer`                 |        (not defined)        |
|    canned_message.inputbroker_pin_b    |                 `integer`                 |        (not defined)        |
|  canned_message.inputbroker_pin_press  |                 `integer`                 |        (not defined)        |

:::tip совет

Так как устройство перезагружается после каждой команды из CLI, при установке нескольких значений в одном разделе удобнее объединить команды в одну.

```shell title="Пример:"
meshtastic --set canned_message.enabled true --set canned_message.send_bell true
```

:::

```shell title="Включить/выключить модуль шаблонных сообщений"
meshtastic --set canned_message.enabled true
meshtastic --set canned_message.enabled false
```

```shell title="Включить/выключить отправку символа звонка"
meshtastic --set canned_message.send_bell true
meshtastic --set canned_message.send_bell false
```

```shell title="Задать сообщения"
meshtastic --set-canned-message "I need an alpinist!|Call Me|Roger Roger|Keep Calm|On my way"
```

```shell title="Выбрать источник ввода"
meshtastic --set canned_message.allow_input_source "_any"
meshtastic --set canned_message.allow_input_source "rotEnc1"
```

```shell title="Включить/выключить rotary1"
meshtastic --set canned_message.rotary1_enabled 1
```

```shell title="Задать/сбросить пин энкодера A"
meshtastic --set canned_message.inputbroker_pin_a 17
meshtastic --set canned_message.inputbroker_pin_a 0
```

```shell title="Задать/сбросить пин энкодера B"
meshtastic --set canned_message.inputbroker_pin_b 39
meshtastic --set canned_message.inputbroker_pin_b 0
```

```shell title="Задать/сбросить пин Press"
meshtastic --set canned_message.inputbroker_pin_press 21
meshtastic --set canned_message.inputbroker_pin_press 0
```

```shell title="Задать/сбросить событие CW"
meshtastic --set canned_message.inputbroker_event_cw UP
meshtastic --set canned_message.inputbroker_event_cw ""
```

```shell title="Задать/сбросить событие CCW"
meshtastic --set canned_message.inputbroker_event_ccw DOWN
meshtastic --set canned_message.inputbroker_event_ccw ""
```

```shell title="Задать/сбросить событие Press"
meshtastic --set canned_message.inputbroker_event_press SELECT
meshtastic --set canned_message.inputbroker_event_press ""
```

</TabItem>
<TabItem value="web">

#### Web

:::note заметка
Все параметры модуля доступны в Web UI.
:::

</TabItem>
</Tabs>

:::warning предупреждение
Доступ к GPIO потенциально опасен: неверные параметры могут физически повредить или уничтожить ваше устройство. Перед настройкой убедитесь, что вы понимаете схему именно вашего устройства. Гарантия не предоставляется. Используйте на свой риск.

Для работы модуля требуется подключённое периферийное устройство. Без него он не работает.
:::

## Железо {#hardware}

Чтобы пролистывать и выбирать сообщения, к устройству нужно подключить железо. Сейчас модуль протестирован с обычным rotary encoder, логикой из трёх кнопок up/down/select и несколькими I2C‑клавиатурами. В дальнейшем будут добавлены другие методы ввода.

### I2C Keymatrix {#i2c-keymatrix}

Протестировано с клавиатурой RAK14004. Нажатие сразу отправляет сообщение, привязанное к номеру кнопки. Кнопки на панели нумеруются слева сверху направо вниз. То есть верхняя левая — первое сообщение, вторая — второе и т. д.

**Особенность:** у RAK 3x4 при сканировании отсутствует 4‑я строка, поэтому каждый 4‑й слот сообщения нужно пропустить. Кнопка 1 отправляет сообщение 1, а кнопка 4 — сообщение 5.
Пример: 1|2|3||5|6|7||9|10|11||13|14|15 — слоты 4, 8 и 12 использовать нельзя.

### CardKB {#cardkb}

CardKB полностью поддерживается в режимах freetext и select. Используйте UP/DOWN/ENTER, чтобы выбрать заготовку и отправить её. Для свободного текста просто наберите его и нажмите ENTER для отправки.

Если не хотите отправлять freetext в broadcast, можно отправить его на конкретный Node. Нажмите TAB и выберите целевой узел клавишами LEFT/RIGHT. Сообщение уйдёт на Node с совпадающими именем и номером. Выбранный Node запомнится для следующего сообщения.

### 3 кнопки up/down и RAK rotary encoder {#3-button-updown-and-rak-rotary-encoder}

Просто используйте UP/DOWN/ENTER, чтобы выбрать заготовку и отправить её.

### Scan and Select {#scan-and-select}

Одна кнопка для прокрутки и отправки заготовок.

#### Настройка {#setup}

- Подключите нормально‑разомкнутую кнопку между землёй и выбранным GPIO
- Настройте модуль шаблонных сообщений
  - Установите [Input Source](#input-source) в `scanAndSelect`
  - Задайте [Input Broker Pin Press](#input-broker-pin-press) на выбранный GPIO
  - Задайте [список заготовок](#messages)

#### Использование {#usage}

- Короткое нажатие: прокрутка сообщений
- Долгое нажатие: отправить текущее сообщение в основной Channel

### Rotary encoder {#rotary-encoder}

Meshtastic поддерживает проводные rotary encoder как устройства ввода.

Понадобится обычный rotary encoder. Варианты ниже имеют пять выводов, два из которых — для действия «press», но подойдут и другие типы. Можно использовать и трёхвыводной вариант, где «press» подключается отдельной кнопкой.

<!--- TODO move links to hardware section --->

- [Amazon link](https://www.amazon.com/Rotary-Encoder-Washers-Digital-Potentiometer/dp/B07Y619CZR/ref=sr_1_21?keywords=rotary+encoder&qid=1642317807&sprefix=rotary+enco%2Caps%2C186&sr=8-21)
- [Amazon.DE link](https://www.amazon.de/-/en/sourcing-Degree-Rotary-Encoder-Digital/dp/B07RLZPX5K/ref=sr_1_12?keywords=rotary+encoder&qid=1642320025&sprefix=rotary%2Caps%2C105&sr=8-12)
- [Aliexpress link1](https://www.aliexpress.com/item/32992227812.html?spm=a2g0o.productlist.0.0.1afe21a50SLvi2&algo_pvid=a19c4182-08aa-406d-bfdf-132582ef5ebb&algo_exp_id=a19c4182-08aa-406d-bfdf-132582ef5ebb-23&pdp_ext_f=%7B%22sku_id%22%3A%2266940265509%22%7D&pdp_pi=-1%3B1.66%3B-1%3B-1%40salePrice%3BUSD%3Bsearch-mainSearch)
- [Aliexpress link2](https://www.aliexpress.com/item/32946444853.html?spm=a2g0o.productlist.0.0.1afe21a50SLvi2&algo_pvid=a19c4182-08aa-406d-bfdf-132582ef5ebb&aem_p4p_detail=2022011523263276283624312400022072680&algo_exp_id=a19c4182-08aa-406d-bfdf-132582ef5ebb-6&pdp_ext_f=%7B%22sku_id%22%3A%2266223434642%22%7D&pdp_pi=-1%3B1.91%3B-1%3B-1%40salePrice%3BUSD%3Bsearch-mainSearch)
- [Aliexpress link3](https://www.aliexpress.com/item/10000056483250.html?spm=a2g0o.productlist.0.0.1afe21a50SLvi2&algo_pvid=a19c4182-08aa-406d-bfdf-132582ef5ebb&algo_exp_id=a19c4182-08aa-406d-bfdf-132582ef5ebb-9&pdp_ext_f=%7B%22sku_id%22%3A%2220000000116682147%22%7D&pdp_pi=-1%3B2.51%3B-1%3B-1%40salePrice%3BUSD%3Bsearch-mainSearch)

Подключение rotary encoder. У энкодера два ряда выводов: в одном ряду два вывода, в другом — три. Вид снизу:

```text
  B o --- o PRESS
GND o | |
  A o --- o GND
```

Два вывода — для фиксации нажатия (press). Подключите один из них к GND, другой — к GPIO (не важно, какой куда). Этот вход назовём «PRESS».

Три вывода — для фиксации вращения. Средний подключите к GND, крайние — к GPIO. Обозначим их «A» и «B» по схеме ниже.

```text
A   --||
GND --||]========
B   --||
```

Рекомендуемые GPIO для подключения rotary encoder:

- TTGO LoRa V1:
  - A — GPIO‑22
  - B — GPIO‑23
  - PRESS — GPIO‑21

Есть референсный 3D‑корпус с rotary encoder для TTGO LoRa V1:
[Case for TTGO-ESP32-LORA-OLED-v1.0 with rotary encoder](https://www.thingiverse.com/thing:5178495)

## Примеры {#examples}

- Подключите совместимое периферийное устройство. Запомните номера GPIO — они понадобятся на следующем шаге.

:::note заметка
Замените каждое `GPIO` (x3) ниже на номера GPIO из вашей схемы.
:::

```shell title="Модуль шаблонных сообщений — обязательные настройки для Rotary Encoder"
meshtastic --set canned_message.inputbroker_pin_a GPIO
meshtastic --set canned_message.inputbroker_pin_b GPIO
meshtastic --set canned_message.inputbroker_pin_press GPIO
meshtastic --set canned_message.inputbroker_event_cw UP
meshtastic --set canned_message.inputbroker_event_ccw DOWN
meshtastic --set canned_message.inputbroker_event_press SELECT
meshtastic --set canned_message.rotary1_enabled True
```

Готово! Когда rotary encoder подключён и включён, можно настраивать модуль шаблонных сообщений.