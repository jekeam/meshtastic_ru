---
id: store-and-forward-module
title: Настройки модуля Store & Forward
sidebar_label: Store & Forward
description: Этот модуль позволяет повторно отправлять текстовые сообщения, если устройство временно было вне диапазона LoRa в mesh.
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import { Icon } from "@iconify/react";

## Обзор {#overview}

С этим модулем клиентское устройство может попросить специальный Store & Forward Server переслать текстовые сообщения после того, как клиент временно был вне диапазона LoRa в mesh.
Начиная с прошивки 2.4, при подключении клиентского приложения к Store & Forward Server история подтянется автоматически — она намного больше стандартного кеша устройства (~30 пакетов).

:::info информация
Store & Forward Server возможен только на устройствах на ESP32 с PSRAM, например T-Beam и T3S3.
:::

Когда клиент запрашивает историю у Store & Forward Server, сервер переотправляет по LoRa полученные им текстовые сообщения. Сервер вернет только сообщения в пределах запрошенного временного окна и не больше максимума, заданного в настройках сервера.
Сервер не знает, какие именно сообщения клиент пропустил, поэтому возможны дубликаты.

:::important важно
Будьте осторожны с запросом истории — сервер может отправить много сообщений и ненадолго нагрузить ваш mesh.
Запрос истории по LoRa недоступен на стандартном публичном канале.
:::

## Подробности {#details}

### Как это работает {#how-it-works}

![Store & Forward — обзор](/img/modules/store_and_forward/store_and_forward-overview.webp)

### Требования {#requirements}

Базовые требования для Store & Forward Server:

- Store & Forward Server предполагается держать всегда онлайн. Если модуль пропустит сообщения, надежность хранимых данных снизится.
- Устройство на процессоре ESP32 с PSRAM (T-Beam > v1.0, T3S3 и др.).

### Кратко об использовании {#usage-overview}

- Для использования/теста по LoRa нужны минимум 3 устройства:

  - Одно устройство ESP32 с PSRAM, настроенное как `ROUTER`, или с установленным `store_forward.is_server`.
  - Еще два — обычные клиенты. Если один клиент отправит текст, пока второй вне диапазона, второй сможет запросить историю у сервера и получить пропущенное сообщение, когда вернется в зону действия.

- Для использования/теста с клиентским приложением нужны минимум 2 устройства:
  - Одно устройство ESP32 с PSRAM, настроенное как `ROUTER`, или с установленным `store_forward.is_server`.
  - Еще одно устройство, которое отправляет текстовые сообщения, когда приложение не подключено к Store & Forward Server. Когда вы подключите приложение к серверу, история подтянется автоматически.

### Настройка сервера {#server-setup}

- Настройте устройство как `ROUTER` или установите `store_forward.is_server true`.
- Дайте серверной ноде понятное имя, например "Base Node (S&F)".
- Настройте модуль Store & Forward

  ```shell title="Обязательно — включить модуль"
  meshtastic --set store_forward.enabled true
  ```

  ```shell title="Необязательно — выключить отправку heartbeat."
  meshtastic --set store_forward.heartbeat false
  ```

  :::tip подсказка
  Лучше отключить heartbeat (он отправляется каждые 15 минут), чтобы снизить трафик, если вы собираете историю только при подключении приложения к серверу или когда все клиенты уже обнаружили сервер.
  :::

### Использование на клиенте {#client-usage}

Реализовано в Android и Apple приложениях версии 2.2.23 и выше. Чтобы запросить историю у Store & Forward Server, на Android нужно отправить ему личное сообщение с текстом "SF" (без кавычек). Сервер ответит запрошенными сообщениями.
Приложения Apple также показывают в списке, является ли нода Store & Forward Server, после получения heartbeat. Затем можно сделать долгое нажатие на ноде и выбрать "Client History", чтобы запросить историю с сервера.

Начиная с 2.4, при подключении непосредственно к Store & Forward Server история сообщений подтянется автоматически и отобразится в приложении.

## Настройки {#settings}

### Включено {#enabled}

Включает модуль.

### Heartbeat {#heartbeat}

Store & Forward Server периодически отправляет сообщение в сеть. Это позволяет устройствам знать, что сервер в зоне досягаемости и слушает входящие сообщения. Клиент, такой как Android, iOS или Web (если поддерживается), может показывать, доступен ли Store & Forward Server.

### Макс. сообщений в истории {#history-return-max}

Максимум сообщений, возвращаемых клиенту при запросе истории.

### Временное окно истории {#history-return-window}

Ограничивает период (в минутах), который может запросить клиент.

### Записи {#records}

Максимальное число записей, которое сервер будет хранить. Обычно лучше оставить значение по умолчанию (`0`) — модуль использует 2/3 доступной PSRAM устройства. Это около 11 000 записей.

### Режим сервера {#is-server}

Установите true, чтобы настроить вашу ноду с PSRAM как Store & Forward Server для хранения и пересылки сообщений. Это альтернатива режиму `ROUTER` и доступно начиная с 2.4.

## Доступность настроек клиента для модуля Store & Forward {#store-and-forward-module-config-client-availability}

<Tabs
  groupId="settings"
  defaultValue="apple"
  values={[
    {
      label: (
        <>
          <Icon icon="mdi:android" height="1.5rem" style={{ marginRight: "0.25rem" }} /> Android
        </>
      ),
      value: "android",
    },
    {
      label: (
        <>
          <Icon icon="mdi:apple" height="1.5rem" style={{ marginRight: "0.25rem" }} /> Apple
        </>
      ),
      value: "apple",
    },
    {
      label: (
        <>
          <Icon icon="mdi:terminal" height="1.5rem" style={{ marginRight: "0.25rem" }} /> CLI
        </>
      ),
      value: "cli",
    },
    {
      label: (
        <>
          <Icon icon="mdi:internet" height="1.5rem" style={{ marginRight: "0.25rem" }} /> Web
        </>
      ),
      value: "web",
    },
  ]}>

<TabItem value="android">

#### Android {#android}

:::info информация
Настройки Store & Forward доступны на Android.

1. Откройте приложение Meshtastic
2. Перейдите: **Vertical Ellipsis (3 dots top right) > Radio Configuration > Store & Forward**

:::

</TabItem>

<TabItem value="apple">

#### Apple {#apple}

:::info информация
Все настройки модуля Store & Forward доступны на iOS, iPadOS и macOS: Settings > Module Configuration > Store & Forward.
:::

</TabItem>

<TabItem value="cli">

#### CLI {#cli}

|            Параметр            | Допустимые значения |        По умолчанию        |
| :----------------------------: | :-----------------: | :------------------------: |
|       store_forward.enabled    |  `true`, `false`    |          `false`           |
|      store_forward.heartbeat   |  `true`, `false`    |          `false`           |
| store_forward.history_return_max |     `integer`     |    `0` (25 сообщений)      |
| store_forward.history_return_window |  `integer`    |   `0` (240 минут)          |
|       store_forward.records    |     `integer`       | `0` (≈11 000 записей)      |
|      store_forward.is_server   |  `true`, `false`    |          `false`           |

:::tip подсказка

Так как устройство перезагружается после каждой команды из CLI, при настройке нескольких значений в одном разделе лучше объединить команды в одну.

```shell title="Пример:"
meshtastic --set store_forward.enabled true --set store_forward.history_return_max 0
```

:::

##### Примеры команд CLI {#examples-of-cli-usage}

```shell title="Включить модуль"
meshtastic --set store_forward.enabled true
```

```shell title="Выключить модуль"
meshtastic --set store_forward.enabled false
```

```shell title="Сделать ноду сервером"
meshtastic --set store_forward.is_server true
```

```shell title="Сбросить store_forward.heartbeat (по умолчанию)"
meshtastic --set store_forward.heartbeat 0
```

```shell title="Сбросить store_forward.history_return_max (25 сообщений)"
meshtastic --set store_forward.history_return_max 0
```

```shell title="Установить store_forward.history_return_max = 100 сообщений"
meshtastic --set store_forward.history_return_max 100
```

```shell title="Сбросить store_forward.history_return_window (240 минут)"
meshtastic --set store_forward.history_return_window 0
```

```shell title="Установить store_forward.history_return_window = 1 день (1440 минут)"
meshtastic --set store_forward.history_return_window 1440
```

```shell title="Сбросить store_forward.records (≈11 000 записей)"
meshtastic --set store_forward.records 0
```

```shell title="Установить store_forward.records = 100 записей"
meshtastic --set store_forward.records 100
```

</TabItem>

<TabItem value="web">

#### Web {#web}

:::info информация
Все настройки модуля Store & Forward доступны в Web UI: Config > Module Config > S&F.
:::

</TabItem>
</Tabs>